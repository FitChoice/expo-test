# Правила упражнений (Exercise Rules)

Эта папка содержит JSON-файлы с правилами для FSM (конечный автомат) подсчёта повторений и проверки техники.

## Структура файла

Каждое упражнение описывается в отдельном JSON-файле со следующей структурой:

```json
{
  "exercise": "exercise_name",
  "axis": "progress_axis_name",
  "states": ["Top", "Down", "Bottom", "Up"],
  "thresholds": {
    "down_enter": -0.08,
    "bottom_enter": -0.22,
    "up_enter": -0.10,
    "top_enter": -0.02,
    "min_dwell_ms": 120
  },
  "rep_on_transition": "Up->Top",
  "hysteresis": 0.015,
  "anti_yaw_max": 0.25,
  "quality": {
    "rom_angle_min": 80,
    "knee_valgus_max": 0.12,
    "torso_lean_max": 18
  }
}
```

## Как добавить новое упражнение

### Шаг 1: Создать файл правил

Создайте файл `{exercise_id}.json` в папке `rules/` (например, `deadlift.json`):

```bash
cp rules/squat.json rules/deadlift.json
```

### Шаг 2: Заполнить параметры

#### Обязательные поля

- **`exercise`** (строка): название упражнения (`deadlift`)
- **`axis`** (строка): имя оси прогресса в features (`deadlift_depth`)
- **`states`** (массив): всегда `["Top", "Down", "Bottom", "Up"]`
- **`thresholds`** (объект):
  - `down_enter`: порог для перехода Top → Down
  - `bottom_enter`: порог для перехода Down → Bottom (самое глубокое значение)
  - `up_enter`: порог для перехода Bottom → Up
  - `top_enter`: порог для перехода Up → Top (самое высокое значение)
  - `min_dwell_ms`: минимальное время в миллисекундах в состоянии перед переходом (защита от дребезга)
- **`rep_on_transition`** (строка): переход, при котором считается повтор (`Up->Top`)
- **`hysteresis`** (число): гистерезис для предотвращения быстрых переключений (обычно 0.01–0.02)

#### Опциональные поля

- **`anti_yaw_max`** (число, 0–1): максимальное значение прокси yaw для допуска подсчёта повторов (`null` = отключено)
- **`quality`** (объект): пороги для проверки техники:
  - `rom_angle_min`: минимальный угол ROM в градусах
  - `knee_valgus_max`: максимальное вальгусное отклонение колена
  - `torso_lean_max`: максимальный наклон корпуса в градусах
  - `body_alignment_max`: максимальное отклонение выравнивания тела
  - `head_position_max`: максимальное отклонение позиции головы в градусах

### Шаг 3: Реализовать ось прогресса

Убедитесь, что в `src/poseflow/features.py` вычисляется фича с именем `{axis}` (например, `deadlift_depth`). Эта фича должна отражать глубину/прогресс упражнения:

- **Отрицательные значения** = более глубокое выполнение
- **Положительные значения** = более высокое положение
- **Больше по модулю** = больший диапазон движения

Пример для приседания:
- `squat_depth = -0.05` → вверху (Top)
- `squat_depth = -0.24` → внизу (Bottom)

### Шаг 4: Настроить конфигурацию

В `configs/app.{local,dev,prod}.yaml` установите:

```yaml
fsm:
  rules_dir: rules
  exercise_id: deadlift  # ← ваш exercise_id
```

Или передайте при создании:

```python
from poseflow.orchestrator import Orchestrator

orc = Orchestrator(cfg, exercise_id="deadlift")
```

## Примеры

### Приседание (`squat.json`)
- **Axis**: `squat_depth` (изменение высоты бёдер)
- **Пороги**: глубокая нижняя точка (-0.22), быстрый переход вверх (-0.10)
- **Дребезг**: `min_dwell_ms = 120` для стабильности

### Отжимание (`pushup.json`)
- **Axis**: `pushup_depth` (изменение высоты грудины)
- **Пороги**: менее глубокая нижняя точка (-0.15), меньший гистерезис (0.01)
- **Дребезг**: `min_dwell_ms = 100`

### Облегчённое приседание (`squat_assisted.json`)
- **Axis**: `squat_depth` (изменение высоты бёдер, как в обычном приседании)
- **Пороги**: меньшая глубина по сравнению с обычным приседанием
- **Особенности**: используется та же ось, что и для `squat`, но с другими порогами

### Ягодичный мост (`hip_bridge.json`)
- **Axis**: `hip_extension_angle` (угол колено->таз->плечо)
- **Пороги**: угол увеличивается при подъёме таза (150° → 175°)
- **Особенности**: лежачее упражнение, использует угол вместо глубины

### Скручивания (`crunch.json`)
- **Axis**: `crunch_angle` (угол нос->грудина->таз)
- **Пороги**: угол увеличивается при подъёме корпуса (88° → 110°)
- **Особенности**: лежачее упражнение, короткие движения

### Отведение ноги в сторону (`leg_abduction_l.json`, `leg_abduction_r.json`)
- **Axis**: `leg_abduction_distance_l/r` (расстояние колено->лодыжка)
- **Пороги**: расстояние увеличивается при отведении ноги (0.55 → 0.82)
- **Особенности**: одностороннее упражнение, лежа на боку

### Отведение ноги назад на четвереньках (`quadruped_hip_extension_l.json`, `quadruped_hip_extension_r.json`)
- **Axis**: `quadruped_hip_extension_distance_l/r` (расстояние таз->колено)
- **Пороги**: расстояние увеличивается при отведении ноги назад (0.44 → 0.69)
- **Особенности**: одностороннее упражнение, на четвереньках

## Логика порогов

Пороги должны соблюдать логический порядок для оси прогресса (отрицательные значения = глубже):

```
top_enter > up_enter > down_enter > bottom_enter
```

Пример:
- `top_enter = -0.02` (высокое положение)
- `up_enter = -0.10`
- `down_enter = -0.08`
- `bottom_enter = -0.22` (самое глубокое)

Гистерезис добавляется к порогам:
- Переход вниз: `axis < threshold - hysteresis`
- Переход вверх: `axis > threshold + hysteresis`

## Валидация

Правила автоматически валидируются при загрузке:
- Проверка JSON-схемы (`schemas/fsm_rule.schema.json`)
- Проверка логической последовательности порогов
- Проверка форматов значений

## Отладка

Если подсчёт повторений работает некорректно:

1. Проверьте порядок порогов (должны быть монотонны)
2. Увеличьте `hysteresis` для защиты от дребезга
3. Увеличьте `min_dwell_ms` если слишком много ложных переходов
4. Проверьте, что `axis` фича корректно вычисляется и имеет нужный диапазон
5. Убедитесь, что `anti_yaw_max` не блокирует нормальные движения

## Документация

- Схема валидации: `schemas/fsm_rule.schema.json`
- Код FSM: `src/poseflow/fsm.py`
- Загрузчик правил: `src/poseflow/fsm_validator.py`

